@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.SignalR.Client
@using PollingStationApp.Data.Helpers.Abstractions
@attribute [StreamRendering]
@rendermode InteractiveServer
@inject ITokenProvider TokenProvider
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IConfiguration Configuration

<PageTitle>Home</PageTitle>
<div class="content">
    <div class="card">
        <div class="card-header">
            <h1>Hello, world!</h1>
            <p>@baseUrl</p>
            <p>@exc</p>
        </div>
        <div class="card-body">
            Welcome to your new app.
            <button class="btn-primary" Color="ButtonColor.Primary" @onclick="OnClick"> Unlock app</button>
        </div>
    </div>
</div>

@code {
    private ClaimsPrincipal? _user;
    private HubConnection? hubConnection;
    private string baseUrl;
    private string exc;

    protected override async Task OnInitializedAsync()
    {
        baseUrl = Configuration["ConnectionStrings:PollingStationAPI"];
        try
        {
            hubConnection = new HubConnectionBuilder()
                .WithUrl($"{baseUrl}/voting") // Change to your actual hub endpoint
                .WithAutomaticReconnect()
            .Build();

            await hubConnection.StartAsync();
        }
        catch (Exception e)
        {
            exc = e.Message;
        }

    }
    protected async void OnClick(EventArgs args)
    {
        Console.WriteLine("click event");
        exc = "click event";
        //var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        //_user = authState.User;
        //var token = await TokenProvider.GetAccessTokenAsync(_user);
        //Console.WriteLine($"Token: {token}");
        if(hubConnection!=null){
            exc = "invoked";
            await hubConnection.InvokeAsync("UnlockApp", "2", "1");
        }
    }
    
    
}